<!DOCTYPE html>

<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>الخزنة</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
 
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- ======================= CSS STYLES ======================= -->
    <style>
        :root {
            --primary-color-light: #4A90E2; --primary-hover-light: #357ABD;
            --background-color-light: #f4f7f9; --surface-color-light: #ffffff;
            --text-color-light: #333; --text-light-light: #777; --border-color-light: #e0e6ed;
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08); --shadow-hover-light: 0 6px 16px rgba(0, 0, 0, 0.12);
            --glass-background-light: rgba(255, 255, 255, 0.6); --glass-border-light: rgba(255, 255, 255, 0.3);
            --glass-shadow-light: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --primary-color-dark: #66B2FF; --primary-hover-dark: #4D94DB;
            --background-color-dark: #1A202C; --surface-color-dark: #2D3748;
            --text-color-dark: #E2E8F0; --text-light-dark: #A0AEC0; --border-color-dark: #4A5568;
            --shadow-dark: 0 4px 12px rgba(0, 0, 0, 0.3); --shadow-hover-dark: 0 6px 16px rgba(0, 0, 0, 0.4);
            --glass-background-dark: rgba(45, 55, 72, 0.6); --glass-border-dark: rgba(74, 85, 104, 0.3);
            --glass-shadow-dark: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            --danger-color: #e74c3c; --danger-hover: #c0392b;
        }
        body.theme-light {
            --primary-color: var(--primary-color-light); --primary-hover: var(--primary-hover-light);
            --background-color: var(--background-color-light); --surface-color: var(--surface-color-light);
            --text-color: var(--text-color-light); --text-light: var(--text-light-light);
            --border-color: var(--border-color-light); --shadow: var(--shadow-light); --shadow-hover: var(--shadow-hover-light);
            --glass-background: var(--glass-background-light); --glass-border: var(--glass-border-light); --glass-shadow: var(--glass-shadow-light);
        }
        body.theme-dark {
            --primary-color: var(--primary-color-dark); --primary-hover: var(--primary-hover-dark);
            --background-color: var(--background-color-dark); --surface-color: var(--surface-color-dark);
            --text-color: var(--text-color-dark); --text-light: var(--text-light-dark);
            --border-color: var(--border-color-dark); --shadow: var(--shadow-dark); --shadow-hover: var(--shadow-hover-dark);
            --glass-background: var(--glass-background-dark); --glass-border: var(--glass-border-dark); --glass-shadow: var(--glass-shadow-dark);
        }
        *, *::before, *::after { box-sizing: border-box; }

        /* Language-specific font families */
        html[lang="ar"] body, html[lang="ar"] button, html[lang="ar"] input, html[lang="ar"] textarea, html[lang="ar"] select { font-family: 'Tajawal', sans-serif; }
        html[lang="en"] body, html[lang="en"] button, html[lang="en"] input, html[lang="en"] textarea, html[lang="en"] select { font-family: 'Roboto', sans-serif; }
        html[lang="he"] body, html[lang="he"] button, html[lang="he"] input, html[lang="he"] textarea, html[lang="he"] select { font-family: 'Heebo', sans-serif; }

        body { margin: 0; background-color: var(--background-color); color: var(--text-color); transition: background-color 0.3s ease, color 0.3s ease; min-height: 100vh; display: flex; flex-direction: column; }
        .view { flex-grow: 1; display: flex; flex-direction: column; padding-bottom: 70px; }
        .hidden { display: none !important; }
        header { padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; flex-wrap: wrap; gap: 0.8rem; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .glassmorphism-header { background: var(--glass-background); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--glass-border); box-shadow: var(--glass-shadow); }
        header h1 { color: var(--primary-color); margin: 0; font-size: 1.5rem; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60%; }
        .header-controls { display: flex; gap: 0.8rem; flex-wrap: wrap; justify-content: flex-end; flex-grow: 1; align-items: center; }
        main { padding: 1.5rem; flex-grow: 1; overflow-y: auto; }
        #auth-view { justify-content: center; align-items: center; padding: 1rem; background: linear-gradient(135deg, var(--primary-color) 0%, var(--background-color) 100%); }
        .auth-container { padding: 2rem; border-radius: 16px; width: 100%; max-width: 400px; text-align: center; margin-top: 1rem; transition: background 0.3s ease, box-shadow 0.3s ease; }
        .glassmorphism-card { background: var(--glass-background); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid var(--glass-border); box-shadow: var(--glass-shadow); }
        .auth-container h2 { margin-top: 0; margin-bottom: 1.5rem; font-weight: 700; font-size: 1.8rem; color: var(--text-color); }
        .auth-container p { margin-top: 1rem; font-size: 0.95rem; }
        .auth-container a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
        form input, form textarea, form select { width: 100%; padding: 1rem; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 10px; font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s, color 0.3s; background-color: var(--surface-color); color: var(--text-color); }
        form input:focus, form textarea:focus, form select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2); }
        form label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color); font-size: 0.95rem; }
        html[dir="rtl"] form label { text-align: right; }
        html[dir="ltr"] form label { text-align: left; }
        button, .btn { padding: 0.9rem 1.8rem; border: none; border-radius: 10px; cursor: pointer; font-size: 1.05rem; font-weight: 500; transition: background-color 0.2s, transform 0.1s, color 0.2s, border-color 0.2s; white-space: nowrap; }
        button:hover { transform: translateY(-2px); }
        .primary-btn, form button[type="submit"] { background-color: var(--primary-color); color: #fff; width: 100%; margin-top: 1.2rem; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .secondary-btn { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-color); }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 0.8rem; }
        .toolbar h2 { margin: 0; flex-shrink: 0; font-size: 1.6rem; color: var(--text-color); }
        .toolbar .primary-btn { width: auto; margin-top: 0; flex-shrink: 0; padding: 0.8rem 1.2rem; font-size: 0.95rem; }
        #search-input { min-width: unset; width: 100%; flex-grow: 1; padding: 0.9rem; border-radius: 10px; border: 1px solid var(--border-color); background-color: var(--surface-color); color: var(--text-color); margin-top: 0.5rem; }
        #date-search-input { padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--surface-color); color: var(--text-color); flex-grow: 1; min-width: 150px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .card { background-color: var(--surface-color); border-radius: 12px; box-shadow: var(--shadow); padding: 1rem; display: flex; flex-direction: column; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s; border: 1px solid transparent; }
        .card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); border-color: var(--primary-color); }
        .card h4 { margin-top: 0; margin-bottom: 0.4rem; word-break: break-word; font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 0.4rem; color: var(--text-color); }
        .card p { color: var(--text-light); font-size: 0.85rem; flex-grow: 1; line-height: 1.4; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: var(--text-light); padding-top: 0.8rem; margin-top: 0.8rem; border-top: 1px solid var(--border-color); }
        .card-actions button { background: none; border: none; cursor: pointer; padding: 0.4rem; font-size: 1rem; border-radius: 50%; width: 36px; height: 36px; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s, color 0.2s; color: var(--text-light); }
        .modal { position: fixed; z-index: 1000; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; padding: 1rem; animation: fadeIn 0.3s ease-out; }
        .modal-content { padding: 2rem; border-radius: 16px; width: 100%; max-width: 450px; position: relative; animation: scaleUp 0.3s ease-out; }
        .modal-content h3 { color: var(--text-color); font-size: 1.5rem; margin-bottom: 1.5rem; }
        .close-button { position: absolute; top: 12px; font-size: 1.4rem; line-height: 1; cursor: pointer; background-color: var(--border-color); border-radius: 50%; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; color: var(--text-light); }
        html[dir="rtl"] .close-button { left: 12px; }
        html[dir="ltr"] .close-button { right: 12px; }
        #loading-spinner { position: fixed; inset: 0; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { border: 6px solid var(--border-color); border-top: 6px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .bottom-nav { display: flex; justify-content: space-around; align-items: center; position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: var(--glass-background); backdrop-filter: blur(10px); border-top: 1px solid var(--glass-border); box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05); z-index: 900; }
        .bottom-nav .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px 0; background: none; border: none; color: var(--text-light); font-size: 0.75rem; font-weight: 500; cursor: pointer; transition: color 0.2s ease; }
        .bottom-nav .nav-item .fas { font-size: 1.4rem; margin-bottom: 3px; }
        .bottom-nav .nav-item.active { color: var(--primary-color); }
        #media-viewer { background-color: var(--background-color); }
        .media-container { flex-grow: 1; display: flex; justify-content: center; align-items: center; padding: 1rem; }
        #image-display, #video-display { max-width: 100%; max-height: calc(100vh - 150px); object-fit: contain; border-radius: 8px; box-shadow: var(--shadow); }
        #text-display { width: 100%; height: 100%; background: var(--surface-color); padding: 1.5rem; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; overflow-y: auto; font-size: 1.1rem; line-height: 1.6; }
        html[dir="rtl"] #text-display { text-align: right; }
        html[dir="ltr"] #text-display { text-align: left; }
        .lang-switcher button { padding: 0.5rem 0.8rem; font-size: 0.9rem; border: 1px solid var(--border-color); background-color: transparent; color: var(--text-color); cursor: pointer; }
        .lang-switcher button.active { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); }
        #logs-list { display: flex; flex-direction: column; gap: 1rem; }
        .log-item { background-color: var(--surface-color); padding: 1rem; border-radius: 8px; box-shadow: var(--shadow); border-left: 5px solid var(--primary-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        html[dir="rtl"] .log-item { border-left: none; border-right: 5px solid var(--primary-color); }
        .log-item p { margin: 0; font-size: 1rem; flex-grow: 1; word-break: break-word; }
        .log-item span { font-size: 0.8rem; color: var(--text-light); flex-shrink: 0; }
        @media (min-width: 769px) { .bottom-nav { display: none; } .view { padding-bottom: 0; } header, main { padding-left: 2.5rem; padding-right: 2.5rem; } .grid-container { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; } #search-input { width: auto; min-width: 300px; margin-top: 0; } }
    </style>
</head>
<body class="theme-light">

    <!-- ======================= HTML BODY CONTENT ======================= -->
    <div id="auth-view" class="view"><div class="auth-container glassmorphism-card"><div id="login-form-container"><h2 data-translate-key="loginTitle">تسجيل الدخول</h2><form id="login-form"><input type="email" id="login-email" data-translate-placeholder="emailPlaceholder" placeholder="البريد الإلكتروني" required><input type="password" id="login-password" data-translate-placeholder="passwordPlaceholder" placeholder="كلمة المرور" required><button type="submit" class="primary-btn" data-translate-key="loginButton">دخول</button></form><p><span data-translate-key="noAccount">ليس لديك حساب؟</span> <a href="#" id="show-signup" data-translate-key="createAccountLink">أنشئ حسابًا</a></p></div><div id="signup-container" style="display: none;"><h2 data-translate-key="signupTitle">حساب جديد</h2><form id="signup-form"><input type="email" id="signup-email" data-translate-placeholder="emailPlaceholder" placeholder="البريد الإلكتروني" required><input type="password" id="signup-password" data-translate-placeholder="passwordPlaceholder" placeholder="كلمة المرور" required><button type="submit" class="primary-btn" data-translate-key="signupButton">تسجيل</button></form><p><span data-translate-key="haveAccount">لديك حساب؟</span> <a href="#" id="show-login" data-translate-key="loginLink">سجل الدخول</a></p></div></div></div>
    
    <div id="main-view" class="view hidden"><header class="glassmorphism-header"><h1 data-translate-key="vaultTitle">الخزنة</h1><div class="header-controls"><div class="lang-switcher"><button id="lang-ar">عربي</button><button id="lang-en">English</button><button id="lang-he">עברית</button></div><input type="search" id="search-input" data-translate-placeholder="searchPlaceholder" placeholder="ابحث..."><button id="logout-button" class="secondary-btn" data-translate-key="logoutButton">تسجيل الخروج</button></div></header><main><div class="toolbar"><h2 data-translate-key="yourFolders">مجلداتك</h2><button id="add-folder-button" class="primary-btn"><i class="fas fa-plus"></i> <span data-translate-key="newFolderButton">مجلد جديد</span></button></div><div id="folders-list" class="grid-container"></div></main></div>
    
    <div id="folder-content-view" class="view hidden"><header class="glassmorphism-header"><button class="back-button"><i class="fas fa-arrow-right"></i></button><h1 id="current-folder-name"></h1></header><main><div class="toolbar"><h2 id="folder-content-title"></h2><input type="date" id="date-search-input"><button id="add-file-button" class="primary-btn"><i class="fas fa-plus"></i> <span data-translate-key="addItemButton">إضافة عنصر</span></button></div><div id="files-list" class="grid-container"></div></main></div>
    
    <div id="media-viewer" class="view hidden"><header class="glassmorphism-header"><button class="back-button-media"><i class="fas fa-arrow-right"></i></button><h1 id="media-title"></h1></header><main class="media-container"><div id="image-viewer" class="hidden"><img id="image-display" src="" data-translate-alt="imageAlt" alt="صورة"></div><div id="video-viewer" class="hidden"><video id="video-display" controls></video></div><div id="text-viewer" class="hidden"><pre id="text-display"></pre></div></main></div>

    <div id="history-view" class="view hidden"><header class="glassmorphism-header"><h1><span data-translate-key="historyTitle">السجل</span></h1></header><main><div id="logs-list"></div></main></div>

    <nav class="bottom-nav"><button class="nav-item active" data-view="main"><i class="fas fa-folder"></i><span data-translate-key="navFolders">المجلدات</span></button><button class="nav-item" data-view="history"><i class="fas fa-history"></i><span data-translate-key="navHistory">السجل</span></button></nav>
    
    <div id="folder-modal" class="modal hidden"><div class="modal-content glassmorphism-card"><span class="close-button">&times;</span><h3 id="modal-title"></h3><form id="folder-form"><input type="hidden" id="folder-id"><label for="folder-name" data-translate-key="folderNameLabel">اسم المجلد:</label><input type="text" id="folder-name" required><label for="folder-description" data-translate-key="descriptionLabel">وصف:</label><textarea id="folder-description" rows="3"></textarea><button type="submit" class="primary-btn" data-translate-key="saveButton">حفظ</button></form></div></div>
    <div id="file-modal" class="modal hidden"><div class="modal-content glassmorphism-card"><span class="close-button">&times;</span><h3 data-translate-key="addItemTitle">إضافة عنصر</h3><form id="file-form"><label for="file-name" data-translate-key="itemNameLabel">اسم العنصر:</label><input type="text" id="file-name" required><label for="file-type" data-translate-key="typeLabel">النوع:</label><select id="file-type"><option value="note" data-translate-key="typeNote">ملاحظة</option><option value="image" data-translate-key="typeImage">صورة</option><option value="video" data-translate-key="typeVideo">فيديو</option></select><div id="note-content-wrapper"><label for="note-content" data-translate-key="contentLabel">المحتوى:</label><textarea id="note-content" rows="5"></textarea></div><div id="file-upload-wrapper" class="hidden"><label for="file-upload" data-translate-key="chooseFileLabel">اختر ملف:</label><input type="file" id="file-upload"></div><button type="submit" class="primary-btn" data-translate-key="saveButton">حفظ</button></form></div></div>
    <div id="loading-spinner" class="hidden"><div class="spinner"></div></div>

    <!-- ======================= JAVASCRIPT LOGIC ======================= -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {

    const translations = { /* ... (Your translations object remains the same) ... */ 
        ar: {
            pageTitle: "الخزنة", loginTitle: "تسجيل الدخول", emailPlaceholder: "البريد الإلكتروني", passwordPlaceholder: "كلمة المرور",
            loginButton: "دخول", noAccount: "ليس لديك حساب؟", createAccountLink: "أنشئ حسابًا",
            signupTitle: "حساب جديد", signupButton: "تسجيل", haveAccount: "لديك حساب؟", loginLink: "سجل الدخول",
            vaultTitle: "الخزنة", searchPlaceholder: "ابحث...", logoutButton: "تسجيل الخروج",
            yourFolders: "مجلداتك", newFolderButton: "مجلد جديد", navFolders: "المجلدات",
            folderContents: "محتويات:", addItemButton: "إضافة عنصر", imageAlt: "صورة",
            folderNameLabel: "اسم المجلد:", descriptionLabel: "وصف:", saveButton: "حفظ",
            addItemTitle: "إضافة عنصر", itemNameLabel: "اسم العنصر:", typeLabel: "النوع:",
            typeNote: "ملاحظة", typeImage: "صورة", typeVideo: "فيديو",
            contentLabel: "المحتوى:", chooseFileLabel: "اختر ملف:",
            noFolders: "لا يوجد مجلدات.", noDescription: "لا يوجد وصف", edit: "تعديل", delete: "حذف",
            emptyFolder: "هذا المجلد فارغ.", fileType: "ملف",
            newFolderModalTitle: "مجلد جديد", editFolderModalTitle: "تعديل المجلد",
            alertConfirmEmail: "تم إرسال رابط تأكيد إلى بريدك الإلكتروني!", alertLinkError: "خطأ في إنشاء رابط العرض: ",
            alertChooseFile: "الرجاء اختيار ملف للرفع.", alertUploadError: "خطأ في رفع الملف: ",
            alertSaveError: "خطأ في حفظ البيانات: ", confirmDeleteFolder: "هل أنت متأكد من حذف هذا المجلد وكل محتوياته؟",
            confirmDeleteItem: "هل أنت متأكد من حذف هذا العنصر؟",
            navHistory: "السجل", historyTitle: "سجل النشاطات", noLogs: "لا يوجد نشاطات مسجلة.",
            logCreateFolder: "أنشأ مجلد:", logDeleteFolder: "حذف مجلد:", logCreateFile: "أنشأ ملف:", logDeleteFile: "حذف ملف:",
        },
        en: {
            pageTitle: "The Vault", loginTitle: "Login", emailPlaceholder: "Email", passwordPlaceholder: "Password",
            loginButton: "Login", noAccount: "Don't have an account?", createAccountLink: "Create one",
            signupTitle: "New Account", signupButton: "Sign Up", haveAccount: "Have an account?", loginLink: "Log in",
            vaultTitle: "The Vault", searchPlaceholder: "Search...", logoutButton: "Logout",
            yourFolders: "Your Folders", newFolderButton: "New Folder", navFolders: "Folders",
            folderContents: "Contents:", addItemButton: "Add Item", imageAlt: "Image",
            folderNameLabel: "Folder Name:", descriptionLabel: "Description:", saveButton: "Save",
            addItemTitle: "Add Item", itemNameLabel: "Item Name:", typeLabel: "Type:",
            typeNote: "Note", typeImage: "Image", typeVideo: "Video", contentLabel: "Content:", chooseFileLabel: "Choose file:",
            noFolders: "No folders found.", noDescription: "No description", edit: "Edit", delete: "Delete",
            emptyFolder: "This folder is empty.", fileType: "file",
            newFolderModalTitle: "New Folder", editFolderModalTitle: "Edit Folder",
            alertConfirmEmail: "A confirmation link has been sent to your email!", alertLinkError: "Error creating view link: ",
            alertChooseFile: "Please choose a file to upload.", alertUploadError: "Error uploading file: ",
            alertSaveError: "Error saving data: ", confirmDeleteFolder: "Are you sure you want to delete this folder and all its contents?",
            confirmDeleteItem: "Are you sure you want to delete this item?",
            navHistory: "History", historyTitle: "Activity Log", noLogs: "No activity logged yet.",
            logCreateFolder: "Created folder:", logDeleteFolder: "Deleted folder:", logCreateFile: "Created file:", logDeleteFile: "Deleted file:",
        },
        he: {
            pageTitle: "הכספת", loginTitle: "כניסה", emailPlaceholder: "אימייל", passwordPlaceholder: "סיסמה",
            loginButton: "כניסה", noAccount: "אין לך חשבון?", createAccountLink: "צור חשבון",
            signupTitle: "חשבון חדש", signupButton: "הרשמה", haveAccount: "יש לך חשבון?", loginLink: "התחבר",
            vaultTitle: "הכספת", searchPlaceholder: "חפש...", logoutButton: "התנתק",
            yourFolders: "התיקיות שלך", newFolderButton: "תיקיה חדשה", navFolders: "תיקיות",
            folderContents: "תוכן:", addItemButton: "הוסף פריט", imageAlt: "תמונה",
            folderNameLabel: "שם התיקיה:", descriptionLabel: "תיאור:", saveButton: "שמור",
            addItemTitle: "הוסף פריט", itemNameLabel: "שם הפריט:", typeLabel: "סוג:",
            typeNote: "הערה", typeImage: "תמונה", typeVideo: "וידאו", contentLabel: "תוכן:", chooseFileLabel: "בחר קובץ:",
            noFolders: "אין תיקיות.", noDescription: "אין תיאור", edit: "ערוך", delete: "מחק",
            emptyFolder: "התיקיה הזו ריקה.", fileType: "קובץ",
            newFolderModalTitle: "תיקיה חדשה", editFolderModalTitle: "ערוך תיקיה",
            alertConfirmEmail: "קישור אישור נשלח לאימייל שלך!", alertLinkError: "שגיאה ביצירת קישור לצפייה: ",
            alertChooseFile: "אנא בחר קובץ להעלאה.", alertUploadError: "שגיאה בהעלאת הקובץ: ",
            alertSaveError: "שגיאה בשמירת הנתונים: ", confirmDeleteFolder: "האם אתה בטוח שברצונך למחוק את התיקיה הזו וכל תכניה?",
            confirmDeleteItem: "האם אתה בטוח שברצונך למחוק את הפריט הזה?",
            navHistory: "היסטוריה", historyTitle: "יומן פעילות", noLogs: "אין פעילות רשומה עדיין.",
            logCreateFolder: "יצר תיקיה:", logDeleteFolder: "מחק תיקיה:", logCreateFile: "יצר קובץ:", logDeleteFile: "מחק קובץ:",
        }
    };
    let currentLang = localStorage.getItem('language') || 'ar';

    // --- 1. SUPABASE SETUP ---
    const SUPABASE_URL = 'https://inexkigotfyhsprhbqyn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImluZXhraWdvdGZ5aHNwcmhicXluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNTc4NDcsImV4cCI6MjA3MTYzMzg0N30.nkDBDL-BFHaTJAUdxzXrPqOzpWonDyr2jkKO2S_UwbU';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- 2. DOM ELEMENTS ---
    const loadingSpinner = document.getElementById('loading-spinner');
    const views = {
        auth: document.getElementById('auth-view'),
        main: document.getElementById('main-view'),
        folderContent: document.getElementById('folder-content-view'),
        mediaViewer: document.getElementById('media-viewer'),
        history: document.getElementById('history-view')
    };
    // Auth elements
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const showSignupLink = document.getElementById('show-signup');
    const showLoginLink = document.getElementById('show-login');
    const signupContainer = document.getElementById('signup-container');
    const logoutButton = document.getElementById('logout-button');
    // Folder elements
    const foldersList = document.getElementById('folders-list');
    const addFolderButton = document.getElementById('add-folder-button');
    const folderModal = document.getElementById('folder-modal');
    const folderForm = document.getElementById('folder-form');
    const folderIdInput = document.getElementById('folder-id');
    const folderNameInput = document.getElementById('folder-name');
    const folderDescriptionInput = document.getElementById('folder-description');
    const folderModalTitle = document.getElementById('modal-title');
    // File elements
    const filesList = document.getElementById('files-list');
    const addFileButton = document.getElementById('add-file-button');
    const fileModal = document.getElementById('file-modal');
    const fileForm = document.getElementById('file-form');
    const fileNameInput = document.getElementById('file-name');
    const fileTypeSelect = document.getElementById('file-type');
    const noteContentWrapper = document.getElementById('note-content-wrapper');
    const noteContentInput = document.getElementById('note-content');
    const fileUploadWrapper = document.getElementById('file-upload-wrapper');
    const fileUploadInput = document.getElementById('file-upload');
    // View-specific elements
    const currentFolderNameHeader = document.getElementById('current-folder-name');
    const folderContentTitleHeader = document.getElementById('folder-content-title');
    const searchInput = document.getElementById('search-input');
    const dateSearchInput = document.getElementById('date-search-input');
    const logsList = document.getElementById('logs-list');
    // Media viewer elements
    const mediaTitle = document.getElementById('media-title');
    const imageViewer = document.getElementById('image-viewer');
    const videoViewer = document.getElementById('video-viewer');
    const textViewer = document.getElementById('text-viewer');
    const imageDisplay = document.getElementById('image-display');
    const videoDisplay = document.getElementById('video-display');
    const textDisplay = document.getElementById('text-display');
    // Navigation
    const bottomNav = document.querySelector('.bottom-nav');
    const closeButtons = document.querySelectorAll('.close-button');

    // --- 3. APPLICATION STATE ---
    let currentUser = null;
    let currentFolderId = null;
    let foldersCache = [];
    let filesCache = [];

    // --- 4. UTILITY & HELPER FUNCTIONS ---
    const showLoading = () => loadingSpinner.classList.remove('hidden');
    const hideLoading = () => loadingSpinner.classList.add('hidden');

    const showModal = (modalElement) => modalElement.classList.remove('hidden');
    const hideModals = () => {
        folderModal.classList.add('hidden');
        fileModal.classList.add('hidden');
    };

    const translate = (key) => translations[currentLang]?.[key] || key;

    const setLanguage = (lang) => {
        currentLang = lang;
        localStorage.setItem('language', lang);
        const langData = translations[lang];
        const isRTL = lang === 'ar' || lang === 'he';

        document.documentElement.lang = lang;
        document.documentElement.dir = isRTL ? 'rtl' : 'ltr';

        document.querySelectorAll('[data-translate-key]').forEach(el => {
            const key = el.dataset.translateKey;
            if (langData[key]) el.innerText = langData[key];
        });
        document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
            const key = el.dataset.translatePlaceholder;
            if (langData[key]) el.placeholder = langData[key];
        });
        document.title = langData.pageTitle;
        
        document.querySelectorAll('.lang-switcher button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`lang-${lang}`).classList.add('active');
        
        // Re-render content if user is logged in
        if (currentUser) {
            renderFolders(foldersCache);
            if (currentFolderId) renderFiles(filesCache);
        }
    };

    // --- 5. CORE LOGIC FUNCTIONS ---

    // Navigation
    const setActiveView = (viewName) => {
        Object.values(views).forEach(v => v.classList.add('hidden'));
        if (views[viewName]) views[viewName].classList.remove('hidden');

        bottomNav.querySelectorAll('.nav-item').forEach(item => {
            item.classList.toggle('active', item.dataset.view === viewName);
        });

        if (viewName === 'history') fetchLogs();
        if (viewName === 'main') fetchFolders();
    };

   
    const logAction = async (action, details = {}) => {
        if (!currentUser) return;
        await supabaseClient.from('logs').insert({ user_id: currentUser.id, action, details });
    };


    const checkUserSession = async () => {
        showLoading();
        const { data: { session } } = await supabaseClient.auth.getSession();
        currentUser = session?.user || null;
        if (currentUser) {
            setActiveView('main');
        } else {
            setActiveView('auth');
        }
        hideLoading();
    };

    const fetchFolders = async (searchTerm = '') => {
        if (!currentUser) return;
        showLoading();
        let query = supabaseClient.from('folders').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
        if (searchTerm) query = query.ilike('name', `%${searchTerm}%`);
        
        const { data, error } = await query;
        hideLoading();

        if (error) {
            console.error('Error fetching folders:', error);
            alert(error.message);
        } else {
            foldersCache = data || [];
            renderFolders(foldersCache);
        }
    };
    
    const renderFolders = (folders) => {
        foldersList.innerHTML = '';
        if (folders.length === 0) {
            foldersList.innerHTML = `<p>${translate('noFolders')}</p>`;
            return;
        }
        folders.forEach(folder => {
            const folderEl = document.createElement('div');
            folderEl.className = 'card';
            folderEl.dataset.id = folder.id;
            folderEl.dataset.name = folder.name;
            folderEl.innerHTML = `
                <h4><i class="fas fa-folder" style="color: #4A90E2;"></i> ${folder.name}</h4>
                <p>${folder.description || translate('noDescription')}</p>
                <div class="card-footer">
                    <span>${new Date(folder.created_at).toLocaleDateString()}</span>
                    <div class="card-actions">
                        <button class="edit-folder" title="${translate('edit')}"><i class="fas fa-pen"></i></button>
                        <button class="delete-folder" title="${translate('delete')}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            foldersList.appendChild(folderEl);
        });
    };

    const openFolder = (folderId, folderName) => {
        currentFolderId = folderId;
        dateSearchInput.value = '';
        setActiveView('folderContent');
        currentFolderNameHeader.textContent = folderName;
        folderContentTitleHeader.textContent = `${translate('folderContents')} ${folderName}`;
        fetchFiles(folderId);
    };

 
    const fetchFiles = async (folderId, searchDate = null) => {
        showLoading();
        let query = supabaseClient.from('files').select('*').eq('folder_id', folderId).order('created_at', { ascending: false });
        if (searchDate) {
            const startDate = `${searchDate}T00:00:00`;
            const endDate = `${searchDate}T23:59:59`;
            query = query.gte('created_at', startDate).lte('created_at', endDate);
        }
        const { data, error } = await query;
        hideLoading();
        if (error) {
            console.error('Error fetching files:', error);
        } else {
            filesCache = data || [];
            renderFiles(filesCache);
        }
    };
    
    const renderFiles = (files) => {
        filesList.innerHTML = '';
        if (files.length === 0) {
            filesList.innerHTML = `<p>${translate('emptyFolder')}</p>`;
            return;
        }
        files.forEach(file => {
            const icon = file.type === 'note' ? 'fa-sticky-note' : (file.type === 'image' ? 'fa-image' : 'fa-video');
            const fileEl = document.createElement('div');
            fileEl.className = 'card';
            fileEl.dataset.id = file.id;
            fileEl.innerHTML = `
                <h4><i class="fas ${icon}"></i> ${file.name}</h4>
                <p>${file.type === 'note' ? ((file.content || '').substring(0, 50) + '...') : `${translate('fileType')} ${file.type}`}</p>
                <div class="card-footer">
                    <span>${new Date(file.created_at).toLocaleDateString()}</span>
                    <div class="card-actions">
                        <button class="delete-file" title="${translate('delete')}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            filesList.appendChild(fileEl);
        });
    };
    
    const openMediaViewer = async (fileId) => {
        const file = filesCache.find(f => f.id === fileId);
        if (!file) return;

        mediaTitle.textContent = file.name;
        imageViewer.classList.add('hidden');
        videoViewer.classList.add('hidden');
        textViewer.classList.add('hidden');
        setActiveView('mediaViewer');

        if (file.type === 'note') {
            textDisplay.textContent = file.content;
            textViewer.classList.remove('hidden');
        } else if (file.file_path) {
            showLoading();
            const { data, error } = await supabaseClient.storage.from('uploads').createSignedUrl(file.file_path, 3600); 
            hideLoading();
            if (error) {
                alert(translate('alertLinkError') + error.message);
                setActiveView('folderContent'); 
                return;
            }
            if (file.type === 'image') {
                imageDisplay.src = data.signedUrl;
                imageViewer.classList.remove('hidden');
            } else if (file.type === 'video') {
                videoDisplay.src = data.signedUrl;
                videoViewer.classList.remove('hidden');
            }
        }
    };

    
    const fetchLogs = async () => {
        if (!currentUser) return;
        showLoading();
        const { data: logs, error } = await supabaseClient.from('logs').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false }).limit(100);
        hideLoading();
        if(error) { console.error('Error fetching logs:', error); return; }
        renderLogs(logs || []);
    };
    
    const renderLogs = (logs) => {
        logsList.innerHTML = '';
        if (logs.length === 0) {
            logsList.innerHTML = `<p>${translate('noLogs')}</p>`;
            return;
        }
        logs.forEach(log => {
            const logEl = document.createElement('div');
            logEl.className = 'log-item';
            const actionKey = `log${log.action.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join('')}`;
            const actionText = translate(actionKey);
            const detailsText = log.details && log.details.name ? `"${log.details.name}"` : '';
            logEl.innerHTML = `<p>${actionText} <strong>${detailsText}</strong></p><span>${new Date(log.created_at).toLocaleString()}</span>`;
            logsList.appendChild(logEl);
        });
    };

    function setupEventListeners() {
       
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            const email = loginForm.querySelector('#login-email').value;
            const password = loginForm.querySelector('#login-password').value;
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            hideLoading();
            if (error) alert(error.message);
            else checkUserSession();
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            const email = signupForm.querySelector('#signup-email').value;
            const password = signupForm.querySelector('#signup-password').value;
            const { error } = await supabaseClient.auth.signUp({ email, password });
            hideLoading();
            if (error) alert(error.message);
            else alert(translate('alertConfirmEmail'));
        });

        logoutButton.addEventListener('click', async () => {
            showLoading();
            await supabaseClient.auth.signOut();
            hideLoading();
            checkUserSession();
        });

        showSignupLink.addEventListener('click', (e) => { e.preventDefault(); signupContainer.style.display = 'block'; loginForm.parentElement.style.display = 'none'; });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); signupContainer.style.display = 'none'; loginForm.parentElement.style.display = 'block'; });

        addFolderButton.addEventListener('click', () => {
            folderForm.reset();
            folderIdInput.value = '';
            folderModalTitle.textContent = translate('newFolderModalTitle');
            showModal(folderModal);
        });

        addFileButton.addEventListener('click', () => {
            fileForm.reset();
            fileTypeSelect.dispatchEvent(new Event('change')); 
            showModal(fileModal);
        });
        
        closeButtons.forEach(btn => btn.addEventListener('click', hideModals));

       
        folderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            const name = folderNameInput.value;
            const description = folderDescriptionInput.value;
            const folderId = folderIdInput.value;
            const isEditing = !!folderId;

            if (isEditing) {
                const { error } = await supabaseClient.from('folders').update({ name, description }).eq('id', folderId);
                hideLoading();
                if (error) alert(error.message);
                else {
                    hideModals();
                    fetchFolders(searchInput.value); 
                }
            } else {
                const { data: newFolder, error } = await supabaseClient.from('folders')
                    .insert({ name, description, user_id: currentUser.id })
                    .select().single();
                hideLoading();
                if (error) alert(error.message);
                else if (newFolder) {
                    hideModals();
                    foldersCache.unshift(newFolder);
                    renderFolders(foldersCache);
                    logAction('CREATE_FOLDER', { name });
                }
            }
        });

        fileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            const name = fileNameInput.value;
            const type = fileTypeSelect.value;
            const fileData = { name, type, folder_id: currentFolderId, user_id: currentUser.id };
            
            try {
                if (type !== 'note') {
                    const file = fileUploadInput.files[0];
                    if (!file) throw new Error(translate('alertChooseFile'));
                    const filePath = `${currentUser.id}/${currentFolderId}/${Date.now()}-${file.name}`;
                    const { error: uploadError } = await supabaseClient.storage.from('uploads').upload(filePath, file);
                    if (uploadError) throw uploadError;
                    fileData.file_path = filePath;
                } else {
                    fileData.content = noteContentInput.value;
                }

                const { data: newFile, error: insertError } = await supabaseClient.from('files').insert(fileData).select().single();
                if (insertError) throw insertError;
                
                if (newFile) {
                    hideModals();
                    filesCache.unshift(newFile);
                    renderFiles(filesCache);
                    logAction('CREATE_FILE', { name });
                }
            } catch (error) {
                alert(error.message);
            } finally {
                hideLoading();
            }
        });

        foldersList.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            const card = e.target.closest('.card');
            if (!card) return;

            if (button) { 
                const folderId = card.dataset.id;
                const folderName = card.dataset.name;
                
                if (button.classList.contains('edit-folder')) {
                    const folder = foldersCache.find(f => f.id === folderId);
                    if (folder) {
                        folderIdInput.value = folder.id;
                        folderNameInput.value = folder.name;
                        folderDescriptionInput.value = folder.description;
                        folderModalTitle.textContent = translate('editFolderModalTitle');
                        showModal(folderModal);
                    }
                } else if (button.classList.contains('delete-folder')) {
                    if (confirm(translate('confirmDeleteFolder'))) {
                        showLoading();
                        await supabaseClient.from('files').delete().eq('folder_id', folderId);
                        await supabaseClient.from('folders').delete().eq('id', folderId);
                        hideLoading();
                        foldersCache = foldersCache.filter(f => f.id !== folderId);
                        renderFolders(foldersCache);
                        logAction('DELETE_FOLDER', { name: folderName });
                    }
                }
            } else { 
                openFolder(card.dataset.id, card.dataset.name);
            }
        });

        filesList.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            const card = e.target.closest('.card');
            if (!card) return;
            const fileId = card.dataset.id;
            
            if (button && button.classList.contains('delete-file')) {
                 if (confirm(translate('confirmDeleteItem'))) {
                    const file = filesCache.find(f => f.id === fileId);
                    if (!file) return;
                    showLoading();
                    if (file.file_path) await supabaseClient.storage.from('uploads').remove([file.file_path]);
                    await supabaseClient.from('files').delete().eq('id', fileId);
                    hideLoading();
                    filesCache = filesCache.filter(f => f.id !== fileId);
                    renderFiles(filesCache);
                    logAction('DELETE_FILE', { name: file.name });
                 }
            } else {
                openMediaViewer(fileId);
            }
        });

    
        searchInput.addEventListener('input', (e) => fetchFolders(e.target.value));
        dateSearchInput.addEventListener('input', (e) => fetchFiles(currentFolderId, e.target.value));
        fileTypeSelect.addEventListener('change', () => {
            const isNote = fileTypeSelect.value === 'note';
            noteContentWrapper.classList.toggle('hidden', !isNote);
            fileUploadWrapper.classList.toggle('hidden', isNote);
        });

       
        bottomNav.addEventListener('click', (e) => {
            const navItem = e.target.closest('.nav-item');
            if (navItem?.dataset.view) setActiveView(navItem.dataset.view);
        });
        document.querySelectorAll('.back-button').forEach(btn => btn.addEventListener('click', () => setActiveView('main')));
        document.querySelector('.back-button-media').addEventListener('click', () => {
            videoDisplay.pause();
            videoDisplay.src = '';
            setActiveView('folderContent');
        });
        
  
        document.getElementById('lang-ar').addEventListener('click', () => setLanguage('ar'));
        document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));
        document.getElementById('lang-he').addEventListener('click', () => setLanguage('he'));
    }

    setLanguage(currentLang);
    setupEventListeners();
    checkUserSession();
});
    </script>
</body>
</html>
